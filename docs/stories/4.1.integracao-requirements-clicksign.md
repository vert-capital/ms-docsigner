# Story 4.1: Integração Requirements Clicksign API

## Status

READY

## Story

**Como** desenvolvedor consumindo a API do ms-docsigner,
**Eu quero** que o sistema integre com o endpoint de requirements da Clicksign (`/api/v3/envelopes/{{envelope_id}}/requirements`),
**Para que** eu possa criar, consultar e gerenciar requisitos de assinatura (ações como "sign", "agree", "provide_evidence" e autenticações como "email", "icp_brasil") em envelopes através da nossa API.

## Acceptance Criteria

1. A entidade EntityRequirement deve ser criada seguindo padrões existentes para representar requisitos de assinatura
2. O campo deve incluir action (sign, agree, provide_evidence), role (sign), auth (email, icp_brasil) e relacionamentos com document e signer
3. Repository interface e implementação para persistir requirements localmente seguindo padrões GORM
4. UseCase para criar, consultar e gerenciar requirements com integração Clicksign
5. Infrastructure service para integração com API Clicksign `/api/v3/envelopes/{{envelope_id}}/requirements`
6. Handler HTTP para endpoint de criação de requirements `POST /api/v1/envelopes/{envelope_id}/requirements`
7. Handler HTTP para endpoint de consulta de requirements `GET /api/v1/envelopes/{envelope_id}/requirements`
8. Integração automática de requirements na criação de envelopes (conforme solicitação do usuário)
9. DTOs de request e response seguindo padrões JSON API para compatibilidade com Clicksign
10. Validações de negócio para campos obrigatórios e valores válidos
11. Logging estruturado para operações de requirements com correlation_id
12. Testes unitários cobrindo entity, usecase, infrastructure e handlers
13. Documentação Swagger atualizada com novos endpoints de requirements

## Tasks / Subtasks

- [ ] Criar entidade EntityRequirement e validações de negócio (AC: 1, 2, 10)

  - [ ] Implementar struct EntityRequirement com campos action, role, auth, document_id, signer_id
  - [ ] Adicionar validações para actions válidas (sign, agree, provide_evidence)
  - [ ] Implementar validações para auth válidos (email, icp_brasil)
  - [ ] Adicionar construtor NewRequirement com validações de negócio
  - [ ] Implementar relacionamentos com envelopes via envelope_id

- [ ] Implementar Repository interface e implementação (AC: 3)

  - [ ] Criar interface IRepositoryRequirement seguindo padrões existentes
  - [ ] Implementar RepositoryRequirement com GORM
  - [ ] Métodos Create, GetByEnvelopeID, GetByID seguindo padrões do projeto
  - [ ] Configurar migrations automáticas via GORM AutoMigrate

- [ ] Desenvolver Infrastructure Service para Clicksign (AC: 5, 9, 11)

  - [ ] Criar RequirementsService em src/infrastructure/clicksign/
  - [ ] Implementar método CreateRequirement integrando com Clicksign API
  - [ ] Implementar método GetRequirementsByEnvelopeID para consulta
  - [ ] Mapear EntityRequirement para DTO Clicksign seguindo JSON API format
  - [ ] Adicionar logging estruturado com correlation_id e metadata

- [ ] Implementar UseCase para orchestração (AC: 4)

  - [ ] Criar interface IUsecaseRequirement seguindo padrões Clean Architecture
  - [ ] Implementar UsecaseRequirementService com dependências injetadas
  - [ ] Método CreateRequirement orquestrando repository e Clicksign service
  - [ ] Método GetRequirementsByEnvelopeID para consulta
  - [ ] Tratamento de erros e regras de negócio específicas

- [ ] Desenvolver handlers HTTP para API (AC: 6, 7)

  - [ ] Implementar CreateRequirementHandler para POST /api/v1/envelopes/{envelope_id}/requirements
  - [ ] Implementar GetRequirementsHandler para GET /api/v1/envelopes/{envelope_id}/requirements
  - [ ] Criar DTOs de request/response seguindo padrões existentes
  - [ ] Validação de envelope_id existe antes de criar requirements
  - [ ] Mapeamento adequado entre DTOs e entidades

- [ ] Integrar requirements na criação de envelopes (AC: 8)

  - [ ] Estender CreateEnvelopeHandler para aceitar requirements opcionais no payload
  - [ ] Modificar EnvelopeCreateRequestDTO para incluir array de requirements
  - [ ] Atualizar UseCase de envelope para criar requirements automaticamente
  - [ ] Garantir transação atômica (envelope + requirements ou rollback completo)

- [ ] Implementar testes unitários abrangentes (AC: 12)

  - [ ] Testes para EntityRequirement e validações de negócio
  - [ ] Testes para RepositoryRequirement com banco de dados em memória
  - [ ] Testes para RequirementsService com mocks do ClicksignClient
  - [ ] Testes para UsecaseRequirementService com mocks de dependências
  - [ ] Testes para handlers HTTP com cenários de sucesso e erro
  - [ ] Testes de integração para fluxo completo envelope + requirements

- [ ] Atualizar documentação e configurar rotas (AC: 13)
  - [ ] Adicionar rotas requirements no router principal
  - [ ] Atualizar documentação Swagger com schemas de requirements
  - [ ] Documentar novos endpoints com exemplos de request/response
  - [ ] Atualizar swagger.json com nova estrutura

## Dev Notes

### Contexto das Stories Anteriores

**Story 3.4 - Response Envelope com Dados Clicksign** [Fonte: docs/stories/3.4.extensao-response-envelope-dados-clicksign.md]:

- EntityEnvelope já implementada com campo ClicksignRawData para dados brutos
- EnvelopeService.CreateEnvelope() retorna (clicksignID, rawData, error)
- Handlers de envelope seguem padrões estabelecidos de mapeamento DTO/entidade
- Logging estruturado implementado com correlation_id e metadata detalhado
- Testes unitários como referência para cenários de sucesso/falha
- Integração Clicksign funcional via cliente HTTP configurado

**Story 2.3 - Criação Envelopes Clicksign** [Fonte: docs/stories/2.3.criacao-envelopes-clicksign.md]:

- EnvelopeService implementado em `src/infrastructure/clicksign/envelope_service.go`
- Cliente HTTP Clicksign configurado e funcional
- JSON API format estabelecido para comunicação com Clicksign
- Estruturas DTO para request/response Clicksign implementadas
- Padrão de mapeamento entidade-para-DTO estabelecido

### Especificações Técnicas da API Clicksign Requirements

**Endpoint Clicksign** [Fonte: docs/clicksign/Clicksign_Postman_Collection.json]:

```
POST /api/v3/envelopes/{{envelope_id}}/requirements
GET /api/v3/envelopes/{{envelope_id}}/requirements
```

**Estrutura JSON API para Criação**:

```json
{
  "data": {
    "type": "requirements",
    "attributes": {
      "action": "agree|sign|provide_evidence",
      "role": "sign",
      "auth": "email|icp_brasil"
    },
    "relationships": {
      "document": {
        "data": { "type": "documents", "id": "{{document_id}}" }
      },
      "signer": {
        "data": { "type": "signers", "id": "{{signer_id}}" }
      }
    }
  }
}
```

**Actions Disponíveis**:

- `agree`: Requisito de concordância
- `sign`: Requisito de assinatura
- `provide_evidence`: Requisito de fornecimento de evidência

**Métodos de Autenticação**:

- `email`: Autenticação via email
- `icp_brasil`: Certificado ICP-Brasil

### Estrutura de Entidade Proposta

**EntityRequirement** [Seguindo padrões em src/entity/entity_envelope.go]:

```go
type EntityRequirement struct {
    ID              int       `json:"id" gorm:"primaryKey"`
    EnvelopeID      int       `json:"envelope_id" gorm:"not null;index" validate:"required"`
    ClicksignKey    string    `json:"clicksign_key" gorm:"index"`
    Action          string    `json:"action" gorm:"not null" validate:"required,oneof=agree sign provide_evidence"`
    Role            string    `json:"role" gorm:"not null;default:'sign'" validate:"required,oneof=sign"`
    Auth            string    `json:"auth" validate:"omitempty,oneof=email icp_brasil"`
    DocumentID      *string   `json:"document_id" gorm:"index"`
    SignerID        *string   `json:"signer_id" gorm:"index"`
    Status          string    `json:"status" gorm:"not null;default:'pending'" validate:"required,oneof=pending completed"`
    CreatedAt       time.Time `json:"created_at"`
    UpdatedAt       time.Time `json:"updated_at"`
}
```

### Padrões de Clean Architecture

**Estrutura de Camadas** [Fonte: docs/architecture/component-architecture.md]:

- **Entity**: EntityRequirement com regras de negócio fundamentais
- **UseCase**: IUsecaseRequirement interface + UsecaseRequirementService implementation
- **Interface Adapters**: Handlers HTTP + Repository implementation
- **Infrastructure**: RequirementsService para integração Clicksign

**Interfaces de Repositório** [Seguindo padrões existentes]:

```go
type IRepositoryRequirement interface {
    Create(ctx context.Context, requirement *entity.EntityRequirement) (*entity.EntityRequirement, error)
    GetByEnvelopeID(ctx context.Context, envelopeID int) ([]entity.EntityRequirement, error)
    GetByID(ctx context.Context, id int) (*entity.EntityRequirement, error)
    Update(ctx context.Context, requirement *entity.EntityRequirement) (*entity.EntityRequirement, error)
}
```

### Estrutura de Arquivos Proposta

**Novos Arquivos a Criar**:

- `src/entity/entity_requirement.go` - Entidade e validações de negócio
- `src/entity/entity_requirement_test.go` - Testes da entidade
- `src/infrastructure/repository/repository_requirement.go` - Implementação repository
- `src/infrastructure/clicksign/requirements_service.go` - Integração Clicksign
- `src/infrastructure/clicksign/requirements_service_test.go` - Testes do service
- `src/infrastructure/clicksign/dto/requirements_dto.go` - DTOs para Clicksign
- `src/usecase/requirement/usecase_requirement_interface.go` - Interface UseCase
- `src/usecase/requirement/usecase_requirement_service.go` - Implementação UseCase
- `src/usecase/requirement/usecase_requirement_service_test.go` - Testes UseCase
- `src/api/handlers/handlers_requirement.go` - Handlers HTTP
- `src/api/handlers/handlers_requirement_test.go` - Testes handlers
- `src/api/handlers/dtos/requirement_dto.go` - DTOs para API
- `src/mocks/mock_usecase_requirement.go` - Mocks para testes
- `src/mocks/mock_repository_requirement.go` - Mocks repository

**Arquivos a Modificar**:

- `src/api/handlers/handlers_envelope.go` - Integrar requirements na criação
- `src/api/handlers/dtos/envelope_dto.go` - Estender EnvelopeCreateRequestDTO
- `src/usecase/envelope/usecase_envelope_service.go` - Suporte a requirements
- `src/api/api.go` - Adicionar rotas de requirements
- `main.go` - Injeção de dependências para requirements

### DTOs de API Propostos

**RequirementCreateRequestDTO**:

```go
type RequirementCreateRequestDTO struct {
    Action     string  `json:"action" validate:"required,oneof=agree sign provide_evidence"`
    Role       string  `json:"role" validate:"required,oneof=sign"`
    Auth       *string `json:"auth" validate:"omitempty,oneof=email icp_brasil"`
    DocumentID *string `json:"document_id"`
    SignerID   *string `json:"signer_id"`
}
```

**RequirementResponseDTO**:

```go
type RequirementResponseDTO struct {
    ID           int       `json:"id"`
    EnvelopeID   int       `json:"envelope_id"`
    ClicksignKey string    `json:"clicksign_key"`
    Action       string    `json:"action"`
    Role         string    `json:"role"`
    Auth         *string   `json:"auth,omitempty"`
    DocumentID   *string   `json:"document_id,omitempty"`
    SignerID     *string   `json:"signer_id,omitempty"`
    Status       string    `json:"status"`
    CreatedAt    time.Time `json:"created_at"`
    UpdatedAt    time.Time `json:"updated_at"`
}
```

### Integração com Criação de Envelopes

**Extensão EnvelopeCreateRequestDTO** [Modificar src/api/handlers/dtos/envelope_dto.go]:

```go
type EnvelopeCreateRequestDTO struct {
    Name             string                         `json:"name" validate:"required,min=3,max=255"`
    Description      string                         `json:"description" validate:"max=1000"`
    DocumentsIDs     []int                          `json:"documents_ids" validate:"required,min=1"`
    SignatoryEmails  []string                       `json:"signatory_emails"`
    Requirements     []RequirementCreateRequestDTO  `json:"requirements,omitempty"` // NOVO
    Message          string                         `json:"message" validate:"max=500"`
    DeadlineAt       *time.Time                     `json:"deadline_at"`
    RemindInterval   int                            `json:"remind_interval" validate:"min=1,max=30"`
    AutoClose        bool                           `json:"auto_close"`
}
```

### Testing Strategy

**Testing Strategy** [Fonte: docs/architecture/testing-strategy.md]:

- Framework padrão Go (`testing`) + biblioteca `testify`
- Mocks organizados em `/mocks/` para interfaces
- Testes unitários obrigatórios para handlers com dependencies mockadas
- Cobertura de cenários de sucesso e falha

**Cenários de Teste Específicos**:

- Criação de requirement com diferentes actions (agree, sign, provide_evidence)
- Criação com diferentes métodos de auth (email, icp_brasil, sem auth)
- Validação de envelope_id existente antes de criar requirement
- Consulta de requirements por envelope_id
- Integração com criação de envelope + requirements automáticos
- Falhas na API Clicksign e tratamento de erros
- Mapeamento correto entre DTOs e entidades
- Logging estruturado em todas as operações

### Configuração e Logging

**Logging Estruturado** [Seguindo padrões estabelecidos]:

```go
logger.WithFields(logrus.Fields{
    "correlation_id":    correlationID,
    "envelope_id":       envelopeID,
    "requirement_action": requirement.Action,
    "requirement_auth":   requirement.Auth,
    "clicksign_key":      requirement.ClicksignKey,
    "step":               "requirement_creation",
}).Info("Requirement created successfully in Clicksign")
```

**Campos de Log Obrigatórios**:

- correlation_id (header X-Correlation-ID)
- envelope_id
- requirement_action
- requirement_auth (quando presente)
- clicksign_key (ID do requirement no Clicksign)
- step (identificação da operação)

### Validações de Negócio

**Regras de Validação**:

1. Action deve ser um dos valores válidos: agree, sign, provide_evidence
2. Role atualmente suporta apenas "sign"
3. Auth é opcional, mas quando presente deve ser "email" ou "icp_brasil"
4. EnvelopeID deve referenciar envelope existente
5. Para action "provide_evidence", auth é obrigatório
6. DocumentID e SignerID são opcionais mas devem referenciar resources válidos quando presentes

**Validação de Relacionamentos**:

- Verificar se envelope_id existe antes de criar requirement
- Validar que document_id e signer_id são válidos no contexto do envelope
- Garantir que não há duplicação de requirements para mesmo document/signer

### Considerações de Performance

**Otimizações**:

- Index em envelope_id para consultas eficientes por envelope
- Index em clicksign_key para lookup rápido
- Lazy loading de requirements em consultas de envelope quando não necessário
- Batch operations para criação de múltiplos requirements

### Testing

**Testing** [Fonte: docs/architecture/testing-strategy.md]:

- **Localização de Testes**: Testes unitários localizados adjacentes ao código fonte
- **Framework**: Go testing padrão + testify para assertions
- **Mocks**: Gerados em `/mocks/` para isolamento de dependências
- **Cobertura**: Obrigatória para entity, usecase, infrastructure e handlers
- **Banco de Teste**: SQLite em memória para testes de repository
- **Cenários**: Sucesso, falha, edge cases e validações de negócio

## Change Log

| Date       | Version | Description                                             | Author             |
| ---------- | ------- | ------------------------------------------------------- | ------------------ |
| 2025-07-20 | 1.0     | Story criada para integração Requirements Clicksign API | Bob (Scrum Master) |
