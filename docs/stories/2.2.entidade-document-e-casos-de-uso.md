# Story 2.2: Entidade Document e Casos de Uso

## Status

Approved

## Story

**Como** desenvolvedor do sistema,
**Eu quero** criar a entidade Document e os use cases relacionados,
**Para que** o sistema possa gerenciar documentos localmente antes de enviá-los para assinatura.

## Acceptance Criteria

1. Entidade Document deve seguir padrões existentes da Clean Architecture
2. Repository interface e implementação devem ser criados para persistência de documentos
3. Use case deve ser implementado para criação e gerenciamento de documentos
4. Validações de negócio devem ser aplicadas para documentos

## Tasks / Subtasks

- [ ] Criar entidade Document seguindo padrões existentes (AC: 1)
  - [ ] Definir estrutura da entidade Document com campos obrigatórios
  - [ ] Implementar construtor NewDocument() com validações
  - [ ] Adicionar método Validate() para validações de negócio
  - [ ] Criar filtros EntityDocumentFilters para consultas
- [ ] Implementar Repository interface e implementação (AC: 2)
  - [ ] Criar IRepositoryDocument interface no use case
  - [ ] Implementar RepositoryDocument no infrastructure/repository
  - [ ] Adicionar métodos CRUD básicos (Create, GetByID, Update, Delete)
  - [ ] Implementar métodos de consulta com filtros
- [ ] Criar use case para gerenciamento de documentos (AC: 3)
  - [ ] Definir IUsecaseDocument interface
  - [ ] Implementar UsecaseDocumentService
  - [ ] Adicionar métodos para criar, atualizar e consultar documentos
  - [ ] Implementar validações específicas de negócio
- [ ] Implementar validações de negócio (AC: 4)
  - [ ] Validar formato e tamanho de arquivos
  - [ ] Validar campos obrigatórios da entidade
  - [ ] Implementar regras de negócio para status do documento
- [ ] Criar testes unitários para todos os componentes (AC: 1, 2, 3, 4)
  - [ ] Testes para entidade Document
  - [ ] Testes para repository com mocks
  - [ ] Testes para use case com mocks
  - [ ] Validar cobertura de testes adequada

## Dev Notes

### Contexto Arquitetural

**Arquitetura Atual:**

- Clean Architecture com separação clara: entity -> usecase -> infrastructure -> api
- Padrão de injeção de dependências via main.go
- Configuração via variáveis de ambiente (config/environment.go)
- Estrutura existente: User entity como exemplo a ser seguido
  [Fonte: docs/architecture/component-architecture.md]

**Padrões de Desenvolvimento:**

- Todas as dependências inicializadas em main.go
- Interfaces definidas no use case para inversão de dependência
- Implementações na camada infrastructure
- Estrutura de pastas baseada na Clean Architecture deve ser mantida
  [Fonte: docs/architecture/coding-standards-and-conventions.md]

### Informações da Story Anterior (2.1)

**Contexto Relevante:**

- Cliente HTTP do Clicksign já configurado (infrastructure/clicksign/client.go)
- Configuração de ambiente estendida com variáveis do Clicksign
- Logging estruturado implementado com correlation IDs
- Patterns de autenticação e comunicação com API externa estabelecidos

### Estrutura de Arquivos para Document

**Baseado na estrutura existente User:**

**Entity:**

- `/src/entity/entity_document.go` - Entidade Document com validações
- `/src/entity/entity_document_test.go` - Testes unitários da entidade

**Use Case:**

- `/src/usecase/document/usecase_document_interface.go` - Interfaces IRepositoryDocument e IUsecaseDocument
- `/src/usecase/document/usecase_document_service.go` - Implementação do use case
- `/src/usecase/document/usecase_document_service_test.go` - Testes unitários

**Infrastructure:**

- `/src/infrastructure/repository/repository_document.go` - Implementação do repositório
- `/src/mocks/mock_usecase_repository_document.go` - Mock gerado para testes
- `/src/mocks/mock_usecase_document.go` - Mock gerado para testes

### Modelo de Dados Document

**Campos Necessários (baseados na integração com Clicksign):**

- ID (int) - Identificador único
- Name (string) - Nome do documento
- FilePath (string) - Caminho do arquivo no sistema
- FileSize (int64) - Tamanho do arquivo em bytes
- MimeType (string) - Tipo MIME do arquivo
- Status (string) - Status do documento (draft, ready, processing, sent)
- ClicksignKey (string) - Chave do documento no Clicksign (nullable)
- Description (string) - Descrição opcional
- CreatedAt (time.Time) - Data de criação
- UpdatedAt (time.Time) - Data de atualização

**Validações:**

- Name: obrigatório, mínimo 3 caracteres, máximo 255
- FilePath: obrigatório, deve existir no sistema
- FileSize: obrigatório, maior que 0
- MimeType: obrigatório, deve ser PDF ou imagem
- Status: obrigatório, deve ser um dos valores válidos

### Padrões de Repositório

**Interface IRepositoryDocument (baseada em IRepositoryUser):**

- GetByID(id int) (\*entity.EntityDocument, error)
- Create(document \*entity.EntityDocument) error
- Update(document \*entity.EntityDocument) error
- Delete(document \*entity.EntityDocument) error
- GetDocuments(filters entity.EntityDocumentFilters) ([]entity.EntityDocument, error)
- GetByClicksignKey(key string) (\*entity.EntityDocument, error)

**Implementação RepositoryDocument:**

- Seguir padrão de RepositoryUser
- Usar GORM para operações de banco
- Implementar filtros para consultas
- Tratamento de erros consistente

### Padrões de Use Case

**Interface IUsecaseDocument:**

- Create(document \*entity.EntityDocument) error
- Update(document \*entity.EntityDocument) error
- Delete(document \*entity.EntityDocument) error
- GetDocument(id int) (\*entity.EntityDocument, error)
- GetDocuments(filters entity.EntityDocumentFilters) ([]entity.EntityDocument, error)
- PrepareForSigning(id int) (\*entity.EntityDocument, error)

**Implementação UsecaseDocumentService:**

- Injeção de dependência do IRepositoryDocument
- Validações de negócio específicas
- Orquestração de operações complexas
- Logging adequado das operações

### Testing

**Padrões de Teste:**

- Framework padrão do Go (testing) + testify para asserções
- Mocks gerados no diretório `/src/mocks/`
- Testes unitários para use cases e entidades
- Cobertura adequada de cenários de erro e sucesso
  [Fonte: docs/architecture/testing-strategy.md]

**Localização dos Testes:**

- Testes unitários: `entity/entity_document_test.go`, `usecase/document/usecase_document_service_test.go`
- Mocks: `mocks/mock_usecase_repository_document.go`, `mocks/mock_usecase_document.go`
- Utilitários de teste: `pkg/testing_utils/`

**Comandos de Geração de Mocks:**

- Use `go:generate` directives nos arquivos de interface
- Executar `go generate ./...` para gerar mocks
- Padrão: `//go:generate mockgen -destination=../../mocks/mock_usecase_repository_document.go -package=mocks`

### Integração com Clicksign

**Preparação para Story 2.3:**

- Campo ClicksignKey para relacionar documento local com Clicksign
- Status do documento deve considerar integração futura
- Validações de formato compatíveis com API do Clicksign
- Método PrepareForSigning() para preparar documento para envio

### Padrões de Configuração

**Banco de Dados:**

- Usar GORM para auto-migration da tabela documents
- Seguir convenções de nomenclatura: snake_case para colunas
- Indices apropriados para performance
- Constraints de integridade referencial

**Validações:**

- Usar tag `validate` nos campos da struct
- Implementar validações customizadas quando necessário
- Retornar erros descritivos para validações falhas
- Seguir padrão de validação da entidade User

## Change Log

| Date       | Version | Description                      | Author |
| ---------- | ------- | -------------------------------- | ------ |
| 2025-07-18 | 1.0     | Story criada com base no épico 2 | SM     |
