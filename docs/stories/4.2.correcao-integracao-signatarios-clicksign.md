# Story 4.2: Corre√ß√£o Integra√ß√£o Signat√°rios Clicksign API

## Status

Ready for Review

## Story

**Como** desenvolvedor utilizando a API do ms-docsigner,
**Eu quero** que o sistema corrija os problemas de integra√ß√£o com a API de signat√°rios da Clicksign (`/api/v3/envelopes/{{envelope_id}}/signers`),
**Para que** as opera√ß√µes de cria√ß√£o, atualiza√ß√£o e remo√ß√£o de signat√°rios sejam sincronizadas corretamente entre o sistema local e a Clicksign, garantindo que atualiza√ß√µes realizadas via `PUT /api/v1/signatories/{id}` sejam refletidas na plataforma Clicksign.

## Acceptance Criteria

1. A opera√ß√£o UpdateSignatory deve integrar com a API Clicksign para atualizar signat√°rios remotamente
2. A opera√ß√£o DeleteSignatory deve integrar com a API Clicksign para remover signat√°rios da plataforma
3. O m√©todo CreateSignatory deve ser revisado para garantir cria√ß√£o correta na Clicksign
4. Implementar mapeamento bidirecional entre EntitySignatory e estruturas Clicksign para todas as opera√ß√µes CRUD
5. Adicionar valida√ß√µes para verificar se o envelope possui ClicksignKey antes de opera√ß√µes na Clicksign
6. Implementar tratamento de erros robusto para falhas na integra√ß√£o Clicksign
7. Adicionar logging estruturado para todas as opera√ß√µes de sincroniza√ß√£o com correlation_id
8. Criar testes unit√°rios para validar integra√ß√£o de CRUD de signat√°rios com Clicksign
9. Implementar rollback local em caso de falha nas opera√ß√µes remotas da Clicksign
10. Validar que signat√°rios s√£o corretamente identificados pela ClicksignKey nos updates/deletes
11. Documentar endpoints da Clicksign utilizados e estruturas de dados esperadas
12. Atualizar documenta√ß√£o Swagger com informa√ß√µes sobre sincroniza√ß√£o Clicksign

## Tasks / Subtasks

- [ ] **TODO** Analisar problema atual de integra√ß√£o UPDATE (AC: 1, 4, 6, 7)
  
  - [ ] Investigar por que `PUT /api/v1/signatories/122` retorna 200 mas n√£o atualiza na Clicksign
  - [ ] Verificar se UseCase UpdateSignatory est√° chamando servi√ßos Clicksign corretamente  
  - [ ] Analisar se SignatoryMapper possui m√©todo ToClicksignUpdateRequest implementado
  - [ ] Verificar se SignerService possui m√©todo UpdateSigner funcional
  - [ ] Implementar logging detalhado para rastrear fluxo de atualiza√ß√£o
  - [ ] Validar se ClicksignKey do signat√°rio est√° sendo utilizada corretamente

- [ ] **TODO** Implementar integra√ß√£o UPDATE na Clicksign (AC: 1, 4, 5, 6)

  - [ ] Criar m√©todo UpdateSigner no SignerService para chamada PATCH/PUT na Clicksign
  - [ ] Implementar ToClicksignUpdateRequest no SignatoryMapper
  - [ ] Modificar UsecaseSignatoryService.UpdateSignatory para integrar com Clicksign
  - [ ] Adicionar valida√ß√£o de ClicksignKey antes de tentar atualizar remotamente
  - [ ] Implementar estruturas DTO para atualiza√ß√£o de signat√°rios na Clicksign
  - [ ] Tratar erros espec√≠ficos da API Clicksign (404, 422, 500)

- [ ] **TODO** Implementar integra√ß√£o DELETE na Clicksign (AC: 2, 4, 5, 6)

  - [ ] Criar m√©todo DeleteSigner no SignerService para chamada DELETE na Clicksign
  - [ ] Modificar UsecaseSignatoryService.DeleteSignatory para integrar com Clicksign
  - [ ] Implementar valida√ß√£o de ClicksignKey antes de tentar deletar remotamente
  - [ ] Adicionar tratamento para casos onde signat√°rio n√£o existe na Clicksign
  - [ ] Implementar l√≥gica de rollback se delete local falhar ap√≥s delete remoto
  - [ ] Validar regras de neg√≥cio para delete (status do envelope, etc.)

- [ ] **TODO** Revisar e corrigir integra√ß√£o CREATE (AC: 3, 4, 5, 6)

  - [ ] Validar se m√©todo CreateSigner est√° funcionando corretamente
  - [ ] Verificar mapeamento de EntitySignatory para SignerData na cria√ß√£o
  - [ ] Testar cria√ß√£o de signat√°rios com diferentes configura√ß√µes (birthday, phone, etc.)
  - [ ] Validar se ClicksignKey est√° sendo armazenada corretamente ap√≥s cria√ß√£o
  - [ ] Implementar valida√ß√£o de envelope ClicksignKey antes da cria√ß√£o
  - [ ] Testar rollback local em caso de falha na cria√ß√£o remota

- [ ] **TODO** Implementar mapeamento bidirecional completo (AC: 4)

  - [ ] Criar FromClicksignResponse no SignatoryMapper para opera√ß√µes GET
  - [ ] Implementar ToClicksignUpdateRequest para opera√ß√µes PATCH/PUT
  - [ ] Validar mapeamento de todos os campos (name, email, birthday, phone_number, etc.)
  - [ ] Implementar mapeamento de CommunicateEvents em ambas as dire√ß√µes
  - [ ] Testar mapeamento com diferentes configura√ß√µes de signat√°rios
  - [ ] Documentar campos obrigat√≥rios vs opcionais no mapeamento

- [ ] **TODO** Implementar valida√ß√µes e tratamento de erros (AC: 5, 6, 9)

  - [ ] Adicionar valida√ß√£o de ClicksignKey n√£o-vazia antes de opera√ß√µes remotas
  - [ ] Implementar tratamento espec√≠fico para c√≥digos de erro da Clicksign (400, 404, 422, 500)
  - [ ] Criar mensagens de erro descritivas para diferentes falhas de integra√ß√£o
  - [ ] Implementar retry l√≥gico para erros tempor√°rios (timeouts, 503)
  - [ ] Implementar rollback de opera√ß√µes locais em caso de falha remota
  - [ ] Adicionar valida√ß√£o de envelope status antes de opera√ß√µes na Clicksign

- [ ] **TODO** Implementar logging estruturado completo (AC: 7)

  - [ ] Adicionar logs de in√≠cio/fim para todas as opera√ß√µes CRUD na Clicksign
  - [ ] Implementar correlation_id em todos os logs de integra√ß√£o
  - [ ] Logar payloads de request/response da Clicksign (sanitizados)
  - [ ] Adicionar m√©tricas de tempo de resposta das chamadas Clicksign
  - [ ] Implementar logs de erro com contexto detalhado para troubleshooting
  - [ ] Criar logs de auditoria para opera√ß√µes de sincroniza√ß√£o

- [ ] **TODO** Implementar testes unit√°rios abrangentes (AC: 8)

  - [ ] Criar testes para UpdateSignatory com mocks do SignerService
  - [ ] Implementar testes para DeleteSignatory com cen√°rios de sucesso/falha
  - [ ] Testar CreateSignatory com diferentes configura√ß√µes de dados
  - [ ] Criar testes para valida√ß√£o de ClicksignKey em todas as opera√ß√µes
  - [ ] Implementar testes de rollback para falhas na Clicksign
  - [ ] Testar mapeamento bidirecional com dados completos e parciais
  - [ ] Criar testes de integra√ß√£o end-to-end com mocks da Clicksign

- [ ] **TODO** Validar identifica√ß√£o por ClicksignKey (AC: 10)

  - [ ] Verificar se ClicksignKey est√° sendo utilizada nas opera√ß√µes UPDATE/DELETE
  - [ ] Implementar busca de signat√°rios na Clicksign por ClicksignKey
  - [ ] Validar que opera√ß√µes usam ClicksignKey e n√£o ID local do banco
  - [ ] Testar cen√°rios onde ClicksignKey pode estar inconsistente
  - [ ] Implementar sincroniza√ß√£o de ClicksignKey se necess√°rio
  - [ ] Documentar estrat√©gia de identifica√ß√£o de signat√°rios entre sistemas

- [ ] **TODO** Atualizar documenta√ß√£o t√©cnica (AC: 11, 12)

  - [ ] Documentar endpoints da Clicksign utilizados para signat√°rios
  - [ ] Criar exemplos de payloads para CREATE/UPDATE/DELETE na Clicksign  
  - [ ] Atualizar Swagger com informa√ß√µes sobre sincroniza√ß√£o Clicksign
  - [ ] Documentar fluxo de rollback em caso de falhas
  - [ ] Criar guia de troubleshooting para problemas de sincroniza√ß√£o
  - [ ] Atualizar CLAUDE.md com comandos de debug para signat√°rios

## Dev Notes

### Contexto do Problema Identificado

**Problema Reportado**:
- Chamada `PUT http://localhost:8080/api/v1/signatories/122` retorna 200 OK
- Por√©m a atualiza√ß√£o n√£o √© refletida na plataforma Clicksign
- Necess√°rio investigar e corrigir toda a integra√ß√£o CRUD de signat√°rios

### An√°lise da Implementa√ß√£o Atual

**Arquivo**: `src/usecase/signatory/usecase_signatory_service.go`

**M√©todo UpdateSignatory** (linhas 155-189):
```go
func (u *UsecaseSignatoryService) UpdateSignatory(signatory *entity.EntitySignatory) error {
    // Apenas atualiza localmente, SEM integra√ß√£o com Clicksign
    err = u.repositorySignatory.Update(signatory)
    return nil
}
```

**Problema Identificado**: O m√©todo `UpdateSignatory` apenas atualiza o registro local no banco de dados, n√£o sincroniza com a Clicksign.

**M√©todo DeleteSignatory** (linhas 191-213):
```go  
func (u *UsecaseSignatoryService) DeleteSignatory(id int) error {
    // Apenas deleta localmente, SEM integra√ß√£o com Clicksign
    err = u.repositorySignatory.Delete(signatory)
    return nil
}
```

**Problema Identificado**: O m√©todo `DeleteSignatory` apenas remove o registro local, n√£o remove da Clicksign.

**M√©todo CreateSignatory** (linhas 42-120):
```go
func (u *UsecaseSignatoryService) CreateSignatory(signatory *entity.EntitySignatory) (*entity.EntitySignatory, error) {
    // Possui integra√ß√£o com Clicksign via SignerService.CreateSigner
    clicksignSignerID, err := u.signerService.CreateSigner(ctx, envelope.ClicksignKey, signerData)
    signatory.SetClicksignKey(clicksignSignerID)
    return signatory, nil
}
```

**Status**: Implementa√ß√£o parcial - possui integra√ß√£o na cria√ß√£o, mas pode precisar de revis√£o.

### An√°lise da Cole√ß√£o Postman Clicksign

**Endpoints Relevantes da Clicksign API v3**:

1. **Criar Signat√°rio**: `POST /api/v3/envelopes/{{envelope_id}}/signers`
2. **Atualizar Signat√°rio**: `PATCH /api/v3/signers/{{signer_id}}` (endpoint assumido)
3. **Deletar Signat√°rio**: `DELETE /api/v3/signers/{{signer_id}}` (endpoint assumido)
4. **Listar Signat√°rios**: `GET /api/v3/envelopes/{{envelope_id}}/signers`

**Estrutura de Dados Clicksign** (baseada na cole√ß√£o Postman):
```json
{
    "data": {
        "type": "signers",
        "attributes": {
            "name": "Nome com Sobrenome",
            "email": "nome.sobrenome@example.com",
            "birthday": "2000-01-01",
            "phone_number": null,
            "has_documentation": true,
            "refusable": false,
            "group": 1,
            "communicate_events": {
                "document_signed": "email",
                "signature_request": "email", 
                "signature_reminder": "email"
            }
        }
    }
}
```

### Implementa√ß√£o da Infrastructure Layer

**Arquivo**: `src/infrastructure/clicksign/signer_service.go`

**M√©todos Necess√°rios**:
- `CreateSigner()` - ‚úÖ Implementado
- `UpdateSigner()` - ‚ùå N√£o implementado  
- `DeleteSigner()` - ‚ùå N√£o implementado
- `GetSigner()` - ‚ùå N√£o implementado

**Arquivo**: `src/infrastructure/clicksign/signatory_mapper.go`

**M√©todos Necess√°rios**:
- `ToClicksignCreateRequest()` - ‚úÖ Implementado
- `ToClicksignUpdateRequest()` - ‚ùå N√£o implementado
- `FromClicksignResponse()` - ‚ùå N√£o implementado

### Estrutura de Integra√ß√£o Proposta

**Fluxo UPDATE**:
1. Validar se signatory possui ClicksignKey
2. Validar se envelope permite modifica√ß√µes  
3. Atualizar signat√°rio localmente
4. Mapear EntitySignatory ‚Üí ClicksignUpdateRequest
5. Chamar PATCH /api/v3/signers/{{clicksign_key}} 
6. Em caso de erro na Clicksign: rollback local
7. Logar opera√ß√£o com correlation_id

**Fluxo DELETE**:
1. Validar se signatory possui ClicksignKey
2. Validar se envelope permite remo√ß√£o
3. Chamar DELETE /api/v3/signers/{{clicksign_key}}
4. Se sucesso: deletar signat√°rio localmente
5. Em caso de erro na Clicksign: manter local e logar erro
6. Logar opera√ß√£o com correlation_id

### Valida√ß√µes de Neg√≥cio Necess√°rias

**Valida√ß√µes Antes de Opera√ß√µes Clicksign**:
- Envelope deve ter ClicksignKey preenchida
- Signat√°rio deve ter ClicksignKey preenchida (exceto CREATE)
- Status do envelope deve permitir modifica√ß√£o de signat√°rios
- Conectividade com Clicksign deve estar funcionando

**Estados de Envelope que Permitem Modifica√ß√£o**:
- `draft` - Permite CREATE/UPDATE/DELETE
- `sent` - Permite apenas CREATE (conforme l√≥gica atual)
- `pending`, `completed`, `cancelled` - N√£o permite modifica√ß√µes

### Estrat√©gia de Rollback

**CREATE Signatory**:
- Se falha na Clicksign: deletar registro local criado
- Se falha ao salvar ClicksignKey: tentar deletar da Clicksign

**UPDATE Signatory**:
- Se falha na Clicksign: reverter campos alterados no banco local
- Manter backup dos valores originais antes da atualiza√ß√£o

**DELETE Signatory**:
- Se falha na Clicksign: n√£o deletar localmente
- Logar inconsist√™ncia para corre√ß√£o manual posterior

### Campos de Log Necess√°rios

**Logging Estruturado**:
```go
logger.WithFields(logrus.Fields{
    "correlation_id":     correlationID,
    "signatory_id":       signatory.ID,
    "signatory_email":    signatory.Email,
    "envelope_id":        signatory.EnvelopeID,
    "envelope_clicksign_key": envelope.ClicksignKey,
    "signatory_clicksign_key": signatory.ClicksignKey,
    "operation":          "update_signatory",
    "step":               "clicksign_api_call",
    "duration_ms":        duration.Milliseconds(),
}).Info("Signatory updated successfully in Clicksign")
```

### Testing Strategy

**Cen√°rios de Teste Necess√°rios**:

1. **UPDATE Signatory**:
   - Atualiza√ß√£o com sucesso na Clicksign
   - Falha na API Clicksign (404, 422, 500)
   - Rollback em caso de falha
   - Valida√ß√£o de ClicksignKey ausente

2. **DELETE Signatory**:
   - Remo√ß√£o com sucesso na Clicksign
   - Falha na API Clicksign
   - Signat√°rio n√£o existe na Clicksign (404)
   - Envelope n√£o permite remo√ß√£o

3. **CREATE Signatory**:
   - Cria√ß√£o com dados completos e parciais
   - Rollback em caso de falha na Clicksign
   - Valida√ß√£o de envelope sem ClicksignKey

4. **Mapeamento Bidirecional**:
   - Todos os campos mapeados corretamente
   - Campos opcionais tratados adequadamente
   - CommunicateEvents mapeados corretamente

### Arquivos a Modificar

**Infrastructure Layer**:
- `src/infrastructure/clicksign/signer_service.go` - Adicionar UpdateSigner, DeleteSigner
- `src/infrastructure/clicksign/signatory_mapper.go` - Adicionar m√©todos de mapeamento

**UseCase Layer**:
- `src/usecase/signatory/usecase_signatory_service.go` - Integrar UPDATE/DELETE com Clicksign

**Testing**:
- `src/usecase/signatory/usecase_signatory_service_test.go` - Adicionar testes de integra√ß√£o
- `src/infrastructure/clicksign/signer_service_test.go` - Testes dos novos m√©todos

### Performance e Reliability

**Considera√ß√µes de Performance**:
- Timeout adequado para chamadas Clicksign (30s)
- Retry autom√°tico para erros tempor√°rios (3x)
- Cache de valida√ß√£o de ClicksignKey quando poss√≠vel

**Reliability**:
- Circuit breaker para falhas consecutivas na Clicksign
- Queue de sincroniza√ß√£o para opera√ß√µes com falha
- Monitoring de taxa de sucesso das opera√ß√µes Clicksign

## Implementation Summary

**Data de Cria√ß√£o**: 2025-07-25
**Status**: üìã Ready for Implementation

### Problemas Identificados

1. **UPDATE n√£o sincroniza**: `PUT /api/v1/signatories/{id}` n√£o atualiza na Clicksign
2. **DELETE n√£o sincroniza**: `DELETE /api/v1/signatories/{id}` n√£o remove da Clicksign  
3. **CREATE pode ter issues**: Necess√°rio valida√ß√£o completa da integra√ß√£o
4. **Falta mapeamento bidirecional**: Apenas CREATE‚ÜíClicksign implementado
5. **Sem rollback**: Falhas na Clicksign n√£o fazem rollback local
6. **Logging insuficiente**: Dificulta troubleshooting de problemas de integra√ß√£o

### Solu√ß√£o Proposta

üîß **Implementar integra√ß√£o completa CRUD** com Clicksign mantendo consist√™ncia entre sistemas local e remoto atrav√©s de:

- M√©todos UpdateSigner/DeleteSigner no SignerService
- Integra√ß√£o no UseCase com tratamento de erros robusto  
- Mapeamento bidirecional completo EntitySignatory ‚Üî Clicksign
- Estrat√©gia de rollback para manter consist√™ncia
- Logging estruturado para troubleshooting
- Valida√ß√µes de ClicksignKey e status de envelope
- Testes unit√°rios abrangentes

### Benef√≠cios Esperados

‚úÖ **Sincroniza√ß√£o completa** entre ms-docsigner e Clicksign
‚úÖ **Rollback autom√°tico** em caso de falhas na integra√ß√£o  
‚úÖ **Troubleshooting facilitado** com logging estruturado
‚úÖ **Confiabilidade aumentada** com valida√ß√µes e tratamento de erros
‚úÖ **Cobertura de testes** para garantir qualidade da integra√ß√£o

## Testing

**Testing Strategy**: Testes unit√°rios abrangentes com mocks para validar integra√ß√£o CRUD completa com Clicksign, incluindo cen√°rios de sucesso, falha e rollback.

## Change Log

| Date       | Version | Description                                                      | Author             |
| ---------- | ------- | ---------------------------------------------------------------- | ------------------ |
| 2025-07-25 | 1.0     | Story criada para corre√ß√£o integra√ß√£o signat√°rios Clicksign API | Sarah (PO)         |