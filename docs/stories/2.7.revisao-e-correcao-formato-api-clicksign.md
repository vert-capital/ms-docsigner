# Story 2.7: Revis√£o e Corre√ß√£o do Formato API Clicksign

## Status

Done

## Story

**Como** desenvolvedor respons√°vel pela integra√ß√£o com Clicksign,
**Eu quero** revisar e corrigir o formato dos dados enviados para a API do Clicksign,
**Para que** a integra√ß√£o esteja em total conformidade com a especifica√ß√£o oficial da API v3.0 e funcione corretamente em produ√ß√£o.

## Acceptance Criteria

1. Revisar a Postman Collection oficial do Clicksign e identificar discrep√¢ncias com a implementa√ß√£o atual
2. Corrigir o formato da estrutura JSON API para cria√ß√£o de envelopes conforme especifica√ß√£o oficial
3. Ajustar a estrutura para cria√ß√£o de documentos seguindo o padr√£o JSON API correto
4. Corrigir a estrutura para cria√ß√£o de signat√°rios conforme formato oficial
5. Implementar estrutura correta para adi√ß√£o de requisitos (qualifica√ß√£o e autentica√ß√£o)
6. Ajustar headers HTTP para usar Content-Type correto: `application/vnd.api+json`
7. Verificar e corrigir endpoints para opera√ß√µes em massa (bulk_requirements)
8. Atualizar todos os DTOs para refletir o formato JSON API correto da API v3.0
9. Implementar testes que validem a conformidade com o formato oficial da API
10. Documentar as corre√ß√µes realizadas e impacto nos endpoints existentes

## Tasks / Subtasks

- [x] An√°lise detalhada da Postman Collection vs implementa√ß√£o atual (AC: 1)

  - [x] Comparar estrutura de cria√ß√£o de envelopes com Postman examples
  - [x] Verificar formato JSON API na cria√ß√£o de documentos
  - [x] Validar estrutura de signat√°rios e requisitos
  - [x] Identificar discrep√¢ncias nos headers HTTP
  - [x] Documentar todas as diverg√™ncias encontradas

- [x] Corre√ß√£o da estrutura JSON API para envelopes (AC: 2, 6)

  - [x] Ajustar `EnvelopeCreateRequestWrapper` conforme formato oficial
  - [x] Corrigir mapeamento em `mapEntityToCreateRequest()`
  - [x] Verificar campos obrigat√≥rios vs opcionais
  - [x] Atualizar Content-Type nos headers para `application/vnd.api+json`

- [x] Implementa√ß√£o da estrutura correta para documentos (AC: 3, 8)

  - [x] Criar DTOs para cria√ß√£o de documentos via JSON API
  - [x] Implementar endpoint POST `/api/v3/envelopes/{envelope_id}/documents`
  - [x] Ajustar campos: `filename`, `content_base64`, `metadata`
  - [x] Implementar suporte a documentos via template (campo `template`)

- [x] Corre√ß√£o da estrutura para signat√°rios (AC: 4, 8)

  - [x] Criar DTOs para cria√ß√£o de signat√°rios conforme JSON API
  - [x] Implementar endpoint POST `/api/v3/envelopes/{envelope_id}/signers`
  - [x] Ajustar campos: `name`, `email`, `birthday`, `phone_number`, `has_documentation`, `refusable`, `group`, `communicate_events`

- [x] Implementa√ß√£o de requisitos (qualifica√ß√£o e autentica√ß√£o) (AC: 5, 8)

  - [x] Criar DTOs para requisitos com estrutura JSON API
  - [x] Implementar endpoint POST `/api/v3/envelopes/{envelope_id}/requirements`
  - [x] Suportar `action: "agree"` e `role: "sign"` para qualifica√ß√£o
  - [x] Suportar `action: "provide_evidence"` e `auth: "email"/"icp_brasil"` para autentica√ß√£o
  - [x] Implementar relacionamentos com `document` e `signer`

- [x] Implementa√ß√£o de opera√ß√µes em massa (AC: 7, 8)

  - [x] Criar DTOs para `bulk_requirements` usando atomic operations
  - [x] Implementar endpoint POST `/api/v3/envelopes/{envelope_id}/bulk_requirements`
  - [x] Suportar opera√ß√µes `add` e `remove` conforme JSON API Spec
  - [x] Implementar estrutura `atomic:operations` array

- [x] Atualiza√ß√£o do servi√ßo HTTP client (AC: 6)

  - [x] Verificar se client est√° enviando Content-Type correto
  - [x] Garantir que todos os requests usem `application/vnd.api+json`
  - [x] Atualizar parsing de responses para JSON API format
  - [x] Implementar tratamento de erro consistente com JSON API

- [x] Implementa√ß√£o de testes de conformidade (AC: 9)

  - [x] Criar testes que validam estrutura JSON API nos requests
  - [x] Testar headers HTTP corretos em todas as chamadas
  - [x] Validar parsing correto das responses JSON API
  - [x] Criar cen√°rios de teste baseados nos examples da Postman Collection
  - [x] Implementar testes de integra√ß√£o com mock server

- [x] Documenta√ß√£o e valida√ß√£o final (AC: 10)
  - [x] Documentar todas as corre√ß√µes no formato da API
  - [x] Atualizar Swagger/OpenAPI documentation
  - [x] Criar guia de migra√ß√£o se necess√°rio
  - [x] Validar que n√£o houve regress√£o nos endpoints existentes

## Dev Notes

### Discrep√¢ncias Identificadas na Postman Collection vs C√≥digo Atual

**Formato JSON API**: A API do Clicksign v3.0 usa rigorosamente o padr√£o JSON API com estrutura `{"data": {"type": "...", "attributes": {...}}}`, mas a implementa√ß√£o atual tem algumas inconsist√™ncias.

**Headers HTTP**: Postman Collection mostra `Content-Type: application/vnd.api+json` em todos os requests, que √© espec√≠fico do JSON API spec.

**Estrutura de Documentos**: Na Postman Collection, documentos s√£o criados com:

```json
{
  "data": {
    "type": "documents",
    "attributes": {
      "filename": "MeuPrimeiroDocumento.pdf",
      "content_base64": "{{content_base64}}",
      "metadata": {
        "type": "private",
        "id": 1,
        "user": 441
      }
    }
  }
}
```

**Estrutura de Signat√°rios**: Postman Collection usa:

```json
{
  "data": {
    "type": "signers",
    "attributes": {
      "name": "Nome com Sobrenome",
      "email": "nome.sobrenome@example.com",
      "birthday": "2000-01-01",
      "phone_number": null,
      "has_documentation": true,
      "refusable": false,
      "group": 1,
      "communicate_events": {
        "document_signed": "email",
        "signature_request": "email",
        "signature_reminder": "email"
      }
    }
  }
}
```

**Estrutura de Requisitos**: Com relacionamentos conforme JSON API:

```json
{
  "data": {
    "type": "requirements",
    "attributes": {
      "action": "agree",
      "role": "sign"
    },
    "relationships": {
      "document": {
        "data": { "type": "documents", "id": "{{document_id}}" }
      },
      "signer": {
        "data": { "type": "signers", "id": "{{signer_id}}" }
      }
    }
  }
}
```

**Opera√ß√µes em Massa**: Postman Collection mostra endpoint `/bulk_requirements` com atomic operations:

```json
{
  "atomic:operations": [
    {
      "op": "remove",
      "ref": {
        "type": "requirements",
        "id": "{{requirement_id}}"
      }
    },
    {
      "op": "add",
      "data": {
        "type": "requirements",
        "attributes": {...},
        "relationships": {...}
      }
    }
  ]
}
```

### Arquitetura e Padr√µes Existentes

**Clean Architecture** [Fonte: docs/architecture/component-architecture.md]:

- Entities: Camada mais interna, cont√©m regras de neg√≥cio
- Use Cases: Orquestra fluxo de dados, define interfaces
- Interface Adapters: Handlers (Gin) e Repositories (GORM)
- Frameworks & Drivers: PostgreSQL, Kafka, APIs externas

**Estrutura de arquivos relevantes**:

- Handler: `/src/api/handlers/handlers_document.go`
- DTO: `/src/infrastructure/clicksign/dto/envelope_dto.go`
- Client: `/src/infrastructure/clicksign/client.go`
- Service: `/src/infrastructure/clicksign/envelope_service.go`
- Interface: `/src/usecase/clicksign/clicksign_client_interface.go`

**Padr√µes de Configura√ß√£o** [Fonte: docs/architecture/coding-standards-and-conventions.md]:

- Inje√ß√£o de Depend√™ncia via construtores
- Configura√ß√£o por vari√°veis de ambiente
- Tratamento de erros propagado por camadas
- Estrutura de pastas seguindo Clean Architecture

### Testing

**Framework de Testes** [Fonte: docs/architecture/testing-strategy.md]:

- Framework padr√£o Go (`testing`)
- Biblioteca `testify` para asser√ß√µes
- Mocks em `/mocks/` gerados para interfaces
- Testes ao lado dos arquivos fonte (`*_test.go`)

**Cen√°rios de teste necess√°rios**:

1. Valida√ß√£o de estrutura JSON API em todos os requests
2. Headers HTTP corretos (`application/vnd.api+json`)
3. Parsing correto de responses JSON API
4. Relacionamentos corretos em requisitos
5. Opera√ß√µes atomic em bulk_requirements
6. Compatibilidade com examples da Postman Collection
7. Tratamento de erros seguindo JSON API spec

### Considera√ß√µes de Implementa√ß√£o

**Compatibilidade**: Manter retrocompatibilidade com c√≥digo existente durante a migra√ß√£o.

**JSON API Spec**: Seguir rigorosamente o padr√£o JSON API (https://jsonapi.org/) conforme implementado pela API v3.0 do Clicksign.

**Content-Type**: Crucial usar `application/vnd.api+json` em todos os requests para a API v3.0.

**Relacionamentos**: Implementar corretamente a se√ß√£o `relationships` conforme JSON API spec para requisitos.

**Atomic Operations**: Para bulk operations, usar a extens√£o JSON API para opera√ß√µes at√¥micas.

## Change Log

| Date       | Version | Description                                                   | Author             |
| ---------- | ------- | ------------------------------------------------------------- | ------------------ |
| 2025-07-19 | 1.0     | Story criada para revis√£o e corre√ß√£o do formato API Clicksign | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-20250514

### Status

Ready for Review

### File List

- `/src/infrastructure/clicksign/dto/envelope_dto.go` - Atualizado com novos DTOs JSON API para documentos, signat√°rios, requisitos e opera√ß√µes em massa
- `/src/infrastructure/clicksign/document_service.go` - Adicionado m√©todo CreateDocument com estrutura JSON API correta
- `/src/infrastructure/clicksign/signer_service.go` - Novo servi√ßo para cria√ß√£o de signat√°rios conforme JSON API spec
- `/src/infrastructure/clicksign/requirement_service.go` - Novo servi√ßo para requisitos e opera√ß√µes em massa conforme JSON API spec
- `/src/infrastructure/clicksign/conformance_test.go` - Testes de conformidade com estrutura JSON API da Postman Collection

### Completion Notes

1. **Estruturas JSON API implementadas**: Todos os DTOs agora seguem rigorosamente o padr√£o JSON API conforme Postman Collection
2. **Relacionamentos implementados**: Requisitos suportam relacionamentos com documentos e signat√°rios conforme spec
3. **Opera√ß√µes at√¥micas**: Bulk requirements implementado com atomic operations conforme JSON API spec
4. **Content-Type correto**: Client j√° configurado com `application/vnd.api+json`
5. **Testes de conformidade**: Valida√ß√£o completa das estruturas JSON API em requests e responses
6. **Compatibilidade**: Mantidas estruturas legadas marcadas como DEPRECATED para retrocompatibilidade

### Debug Log References

Nenhum erro encontrado durante a implementa√ß√£o. Todos os testes de conformidade passaram.

## QA Results

### ‚úÖ Status: Aprovado - Ready for Done

**Revisor:** Quinn (Senior Developer & QA Architect)
**Data da Revis√£o:** 19/07/2025
**Modelo:** claude-sonnet-4-20250514

### üìã Resumo da Revis√£o

A story 2.7 foi **APROVADA** ap√≥s uma revis√£o t√©cnica abrangente. A implementa√ß√£o segue rigorosamente o padr√£o JSON API v3.0 do Clicksign conforme especificado na Postman Collection oficial, demonstrando excelente ader√™ncia aos padr√µes arquiteturais e melhores pr√°ticas.

### ‚úÖ Crit√©rios de Aceita√ß√£o - Status

- [x] **AC1:** Revis√£o da Postman Collection oficial identificou discrep√¢ncias ‚úì
- [x] **AC2:** Formato JSON API para cria√ß√£o de envelopes corrigido ‚úì
- [x] **AC3:** Estrutura para cria√ß√£o de documentos implementada corretamente ‚úì
- [x] **AC4:** Estrutura para signat√°rios implementada conforme padr√£o oficial ‚úì
- [x] **AC5:** Requisitos com qualifica√ß√£o e autentica√ß√£o implementados ‚úì
- [x] **AC6:** Headers HTTP usando `application/vnd.api+json` ‚úì
- [x] **AC7:** Endpoints bulk_requirements com atomic operations ‚úì
- [x] **AC8:** DTOs atualizados para JSON API v3.0 ‚úì
- [x] **AC9:** Testes de conformidade implementados ‚úì
- [x] **AC10:** Documenta√ß√£o das corre√ß√µes realizada ‚úì

### üèóÔ∏è Revis√£o Arquitetural

**‚úÖ Clean Architecture:**

- Correta separa√ß√£o de responsabilidades entre camadas
- Services espec√≠ficos: `DocumentService`, `SignerService`, `RequirementService`
- Inje√ß√£o de depend√™ncias via construtores seguindo padr√µes estabelecidos
- DTOs apropriadamente organizados em `/dto/envelope_dto.go`

**‚úÖ Padr√µes de C√≥digo:**

- Estrutura de arquivos seguindo conven√ß√µes do projeto
- Tratamento consistente de erros com propaga√ß√£o adequada
- Logging estruturado com correlation_id para rastreabilidade
- Nomenclatura clara e descritiva em ingl√™s

### üîç Valida√ß√£o de Implementa√ß√£o vs Postman Collection

**‚úÖ Estruturas JSON API Verificadas:**

1. **Envelopes:** Estrutura `{"data": {"type": "envelopes", "attributes": {...}}}` ‚úì
2. **Documentos:** Implementa√ß√£o correta com `content_base64`, `filename`, `metadata` ‚úì
3. **Signat√°rios:** Campos obrigat√≥rios e opcionais conforme spec: `name`, `email`, `birthday`, `has_documentation`, etc. ‚úì
4. **Requisitos:** Relacionamentos JSON API corretos com `document` e `signer` ‚úì
5. **Bulk Operations:** Atomic operations com estrutura `{"atomic:operations": [...]}` ‚úì

**‚úÖ Headers HTTP:**

- Client configurado com `Content-Type: application/vnd.api+json` (`client.go:198`)
- Header `Accept: application/vnd.api+json` configurado (`client.go:199`)

### üß™ Cobertura de Testes

**‚úÖ Testes de Conformidade:** (`conformance_test.go`)

- Valida√ß√£o completa das estruturas JSON API para todos os endpoints
- Mock do client Clicksign para isolamento de testes
- Verifica√ß√£o de relacionamentos em requisitos
- Teste de atomic operations para bulk requirements
- Parsing correto de responses e error handling

**Pontos Destacados:**

- Uso apropriado do framework `testify` conforme padr√µes do projeto
- Mocks organizados seguindo conven√ß√µes estabelecidas
- Cen√°rios de teste baseados nos examples da Postman Collection

### üîÑ Compatibilidade e Migra√ß√£o

**‚úÖ Estrat√©gia de Compatibilidade:**

- Estruturas legadas mantidas com marca√ß√£o `DEPRECATED` para transi√ß√£o suave
- Novos endpoints n√£o afetam funcionalidades existentes
- Implementa√ß√£o permite migra√ß√£o gradual

### üöÄ Pontos de Excel√™ncia

1. **Ader√™ncia Rigorosa ao JSON API Spec:** Implementa√ß√£o segue perfeitamente o padr√£o oficial
2. **Relacionamentos Corretos:** Implementa√ß√£o correta da se√ß√£o `relationships` conforme JSON API
3. **Atomic Operations:** Suporte completo a opera√ß√µes at√¥micas para bulk requirements
4. **Logging Estruturado:** Excelente rastreabilidade com correlation_id e campos estruturados
5. **Testes Abrangentes:** Cobertura completa de cen√°rios de conformidade
6. **Documenta√ß√£o Clara:** Dev Notes detalhadas facilitam manuten√ß√£o futura

### üèÅ Conclus√£o

A implementa√ß√£o est√° **PRONTA PARA PRODU√á√ÉO**. Todos os crit√©rios de aceita√ß√£o foram atendidos com alta qualidade t√©cnica. A migra√ß√£o para o formato JSON API v3.0 do Clicksign foi executada com excel√™ncia, mantendo compatibilidade e seguindo todas as melhores pr√°ticas arquiteturais do projeto.

### üìã Checklist Final

- [x] Todos os ACs implementados e funcionais
- [x] Testes passando e cobertura adequada
- [x] C√≥digo segue padr√µes arquiteturais do projeto
- [x] Headers HTTP corretos implementados
- [x] Documenta√ß√£o atualizada e clara
- [x] Compatibilidade mantida com implementa√ß√£o legada
- [x] Logging adequado para troubleshooting
- [x] Estruturas JSON API 100% conformes com Postman Collection

**Status Final: ‚úÖ APROVADO - READY FOR DONE**
