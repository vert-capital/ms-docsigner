# Story 2.3: Criação de Envelopes no Clicksign

## Status

Draft

## Story

**Como** usuário do sistema,
**Eu quero** criar envelopes no Clicksign através da API,
**Para que** eu possa enviar documentos para assinatura eletrônica.

## Acceptance Criteria

1. Endpoint HTTP para criação de envelopes deve ser implementado
2. Integração com API do Clicksign para criação de envelopes deve funcionar corretamente
3. Persistência local do status dos envelopes deve ser mantida
4. Tratamento de erros e validações deve ser robusto
5. Documentação Swagger dos novos endpoints deve ser atualizada

## Tasks / Subtasks

- [ ] Criar entidade Envelope seguindo padrões da Clean Architecture (AC: 1, 2, 3)
  - [ ] Definir estrutura da entidade Envelope com campos obrigatórios
  - [ ] Implementar construtor NewEnvelope() com validações
  - [ ] Adicionar método Validate() para validações de negócio
  - [ ] Criar filtros EntityEnvelopeFilters para consultas
- [ ] Implementar Repository interface e implementação para Envelope (AC: 3)
  - [ ] Criar IRepositoryEnvelope interface no use case
  - [ ] Implementar RepositoryEnvelope no infrastructure/repository
  - [ ] Adicionar métodos CRUD básicos (Create, GetByID, Update, Delete)
  - [ ] Implementar métodos de consulta com filtros
- [ ] Criar use case para criação de envelopes (AC: 1, 2, 3)
  - [ ] Definir IUsecaseEnvelope interface
  - [ ] Implementar UsecaseEnvelopeService com injeção de ClicksignClient
  - [ ] Adicionar método CreateEnvelope() que integra com Clicksign API
  - [ ] Implementar validações específicas de negócio
- [ ] Implementar integração com API do Clicksign (AC: 2)
  - [ ] Criar DTOs para request/response do Clicksign
  - [ ] Implementar método CreateEnvelope() no ClicksignClient
  - [ ] Adicionar tratamento de erros específicos da API
  - [ ] Implementar mapeamento entre entidades locais e API do Clicksign
- [ ] Criar endpoint HTTP para criação de envelopes (AC: 1, 4)
  - [ ] Implementar handler CreateEnvelope() no handlers/
  - [ ] Adicionar validação de request payload
  - [ ] Implementar tratamento de erros HTTP apropriado
  - [ ] Adicionar logs estruturados para auditoria
- [ ] Atualizar documentação Swagger (AC: 5)
  - [ ] Adicionar anotações Swagger no handler
  - [ ] Documentar DTOs de request/response
  - [ ] Atualizar swagger.yaml com novos endpoints
  - [ ] Verificar geração automática da documentação
- [ ] Criar testes unitários para todos os componentes (AC: 1, 2, 3, 4)
  - [ ] Testes para entidade Envelope
  - [ ] Testes para repository com mocks
  - [ ] Testes para use case com mocks do Clicksign
  - [ ] Testes para handler com mocks
  - [ ] Validar cobertura de testes adequada
- [ ] Documentar processo de criação de envelopes no Clicksign com exemplos (AC: 5)
  - [ ] Criar arquivo de documentação com exemplos de uso da API
  - [ ] Documentar payload de criação de envelope com campos obrigatórios
  - [ ] Incluir exemplos de request/response para cada endpoint
  - [ ] Documentar regras de negócio da API do Clicksign
  - [ ] Criar exemplos de erro e tratamento adequado
  - [ ] Adicionar exemplos de uso em diferentes cenários (único signatário, múltiplos signatários)
  - [ ] Documentar processo de ativação de envelope (draft -> running)

## Dev Notes

### Contexto Arquitetural

**Arquitetura Atual:**
- Clean Architecture com separação clara: entity -> usecase -> infrastructure -> api
- Padrão de injeção de dependências via main.go
- Configuração via variáveis de ambiente (config/environment.go)
- Estrutura existente: Document entity já implementada como referência
  [Fonte: docs/architecture/component-architecture.md]

**Padrões de Desenvolvimento:**
- Todas as dependências inicializadas em main.go
- Interfaces definidas no use case para inversão de dependência
- Implementações na camada infrastructure
- Estrutura de pastas baseada na Clean Architecture deve ser mantida
  [Fonte: docs/architecture/coding-standards-and-conventions.md]

### Informações das Stories Anteriores

**Contexto da Story 2.1 (Estrutura Base):**
- Cliente HTTP do Clicksign já configurado (infrastructure/clicksign/client.go)
- Configuração de ambiente estendida com variáveis do Clicksign
- Logging estruturado implementado com correlation IDs
- Patterns de autenticação e comunicação com API externa estabelecidos
- Interface ClicksignClientInterface definida em usecase/clicksign/clicksign_client_interface.go

**Contexto da Story 2.2 (Entidade Document):**
- Entidade Document já implementada (src/entity/entity_document.go)
- Repository pattern implementado para Document
- Use case service implementado para Document
- Validações de negócio estabelecidas
- Estrutura de status (draft, ready, processing, sent) já definida

### Estrutura de Arquivos para Envelope

**Baseado na estrutura existente Document:**

**Entity:**
- `/src/entity/entity_envelope.go` - Entidade Envelope com validações
- `/src/entity/entity_envelope_test.go` - Testes unitários da entidade

**Use Case:**
- `/src/usecase/envelope/usecase_envelope_interface.go` - Interfaces IRepositoryEnvelope e IUsecaseEnvelope
- `/src/usecase/envelope/usecase_envelope_service.go` - Implementação do use case
- `/src/usecase/envelope/usecase_envelope_service_test.go` - Testes unitários

**Infrastructure:**
- `/src/infrastructure/repository/repository_envelope.go` - Implementação do repositório
- `/src/infrastructure/clicksign/envelope_service.go` - Serviço para criação de envelopes
- `/src/mocks/mock_usecase_repository_envelope.go` - Mock gerado para testes
- `/src/mocks/mock_usecase_envelope.go` - Mock gerado para testes

**API:**
- `/src/api/handlers/handlers_envelope.go` - Handlers HTTP para envelopes
- `/src/api/handlers/dtos/envelope_dto.go` - DTOs para request/response

### Modelo de Dados Envelope

**Campos Necessários (baseados na API do Clicksign):**
- ID (int) - Identificador único local
- Name (string) - Nome do envelope
- Description (string) - Descrição opcional
- Status (string) - Status do envelope (draft, sent, pending, completed, cancelled)
- ClicksignKey (string) - Chave do envelope no Clicksign
- DocumentsIDs ([]int) - IDs dos documentos locais associados
- CreatedAt (time.Time) - Data de criação
- UpdatedAt (time.Time) - Data de atualização
- SignatoryEmails ([]string) - Emails dos signatários
- Message (string) - Mensagem para os signatários

**Validações:**
- Name: obrigatório, mínimo 3 caracteres, máximo 255
- Status: obrigatório, deve ser um dos valores válidos
- DocumentsIDs: obrigatório, deve conter pelo menos 1 documento
- SignatoryEmails: obrigatório, deve conter pelo menos 1 email válido

### Padrões de Repositório

**Interface IRepositoryEnvelope:**
- GetByID(id int) (*entity.EntityEnvelope, error)
- Create(envelope *entity.EntityEnvelope) error
- Update(envelope *entity.EntityEnvelope) error
- Delete(envelope *entity.EntityEnvelope) error
- GetEnvelopes(filters entity.EntityEnvelopeFilters) ([]entity.EntityEnvelope, error)
- GetByClicksignKey(key string) (*entity.EntityEnvelope, error)

**Implementação RepositoryEnvelope:**
- Seguir padrão de RepositoryDocument
- Usar GORM para operações de banco
- Implementar filtros para consultas
- Tratamento de erros consistente

### Padrões de Use Case

**Interface IUsecaseEnvelope:**
- CreateEnvelope(envelope *entity.EntityEnvelope) (*entity.EntityEnvelope, error)
- GetEnvelope(id int) (*entity.EntityEnvelope, error)
- GetEnvelopes(filters entity.EntityEnvelopeFilters) ([]entity.EntityEnvelope, error)
- UpdateEnvelope(envelope *entity.EntityEnvelope) error
- DeleteEnvelope(id int) error

**Implementação UsecaseEnvelopeService:**
- Injeção de dependência do IRepositoryEnvelope e ClicksignClientInterface
- Validações de negócio específicas
- Integração com API do Clicksign para criação de envelopes
- Logging adequado das operações

### Integração com API do Clicksign

**DTOs para Clicksign API:**
- EnvelopeCreateRequest - estrutura para criação de envelope
- EnvelopeCreateResponse - resposta da API do Clicksign
- DocumentUploadRequest - estrutura para upload de documentos
- SignatoryRequest - estrutura para signatários

**Método CreateEnvelope() no ClicksignClient:**
- Usar o cliente HTTP já configurado (infrastructure/clicksign/client.go)
- Endpoint: POST /envelopes
- Autenticação Bearer Token já implementada
- Retry logic e error handling já implementados

### Especificações da API do Clicksign

**Endpoint Principal:**
- URL: `POST https://sandbox.clicksign.com/api/v3/envelopes`
- Produção: `https://api.clicksign.com/api/v3/envelopes`

**Campos Obrigatórios e Opcionais:**
- `name` (obrigatório): Nome do envelope
- `locale` (opcional): Idioma do documento (padrão: pt-BR, opções: pt-BR, en-US)
- `auto_close` (opcional): Fechar automaticamente após última assinatura (padrão: true)
- `remind_interval` (opcional): Intervalo de lembretes automáticos (padrão: 3 dias)
- `deadline_at` (opcional): Prazo máximo de 90 dias a partir do upload
- `default_subject` (opcional): Máximo 100 caracteres, editável apenas no status 'draft'

**Status do Envelope:**
- `draft`: Envelope criado mas não ativado
- `running`: Envelope ativo para assinatura
- `canceled`: Envelope cancelado
- `closed`: Envelope fechado/concluído

**Regras de Negócio:**
- `deadline_at` deve ser maior que a data/hora atual
- `deadline_at` não pode ser superior a 90 dias da data de upload
- `default_subject` limitado a 100 caracteres
- Maioria dos campos são opcionais na criação

**Endpoints Relacionados:**
- `PATCH /api/v3/envelopes/{envelope_id}`: Editar/ativar envelope
- `GET /api/v3/envelopes/{envelope_id}`: Consultar detalhes do envelope
- `DELETE /api/v3/envelopes/{envelope_id}`: Excluir envelope

**Exemplo de Payload de Criação:**
```json
{
  "name": "Contrato de Prestação de Serviços",
  "locale": "pt-BR",
  "auto_close": true,
  "remind_interval": 3,
  "deadline_at": "2025-10-15T23:59:59Z",
  "default_subject": "Solicitação de assinatura do contrato"
}
```

**Processo de Ativação:**
1. Criar envelope no status 'draft'
2. Configurar documentos e signatários
3. Usar PATCH para alterar status para 'running'
4. Envelope fica disponível para assinatura

### Exemplos de Uso da API

**Exemplo 1: Criação de Envelope Simples**
```bash
curl -X POST https://sandbox.clicksign.com/api/v3/envelopes \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Contrato de Prestação de Serviços",
    "locale": "pt-BR",
    "auto_close": true,
    "remind_interval": 3
  }'
```

**Exemplo 2: Criação com Prazo Definido**
```bash
curl -X POST https://sandbox.clicksign.com/api/v3/envelopes \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Contrato Urgente",
    "locale": "pt-BR",
    "auto_close": true,
    "remind_interval": 1,
    "deadline_at": "2025-08-15T23:59:59Z",
    "default_subject": "Assinatura urgente necessária"
  }'
```

**Exemplo 3: Ativação de Envelope (Draft -> Running)**
```bash
curl -X PATCH https://sandbox.clicksign.com/api/v3/envelopes/ENVELOPE_ID \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "status": "running"
  }'
```

**Exemplo 4: Consulta de Detalhes**
```bash
curl -X GET https://sandbox.clicksign.com/api/v3/envelopes/ENVELOPE_ID \
  -H "Authorization: Bearer YOUR_API_KEY"
```

**Tratamento de Erros Comuns:**
- Status 401: Erro de autenticação - verificar API key
- Status 400: Payload inválido - verificar campos obrigatórios
- Status 422: Regras de negócio violadas - verificar deadline_at e outros campos
- Status 500: Erro interno do servidor - implementar retry logic

### Padrões de Handler HTTP

**Handler CreateEnvelope():**
- Localização: /src/api/handlers/handlers_envelope.go
- Método HTTP: POST
- Endpoint: /api/v1/envelopes
- Validação de payload usando gin binding
- Tratamento de erros HTTP apropriado
- Logs estruturados com correlation ID

**DTOs:**
- EnvelopeCreateRequestDTO - para receber dados do cliente
- EnvelopeResponseDTO - para resposta da API
- ErrorResponseDTO - para erros padronizados

### Documentação Swagger

**Anotações necessárias:**
- @Summary Create envelope
- @Description Create a new envelope in Clicksign
- @Tags envelopes
- @Accept json
- @Produce json
- @Param request body EnvelopeCreateRequestDTO true "Envelope data"
- @Success 201 {object} EnvelopeResponseDTO
- @Failure 400 {object} ErrorResponseDTO
- @Failure 500 {object} ErrorResponseDTO

### Testing

**Padrões de Teste:**
- Framework padrão do Go (testing) + testify para asserções
- Mocks gerados no diretório `/src/mocks/`
- Testes unitários para use cases e entidades
- Cobertura adequada de cenários de erro e sucesso
  [Fonte: docs/architecture/testing-strategy.md]

**Localização dos Testes:**
- Testes unitários: `entity/entity_envelope_test.go`, `usecase/envelope/usecase_envelope_service_test.go`
- Testes de handler: `api/handlers/handlers_envelope_test.go`
- Mocks: `mocks/mock_usecase_repository_envelope.go`, `mocks/mock_usecase_envelope.go`

**Comandos de Geração de Mocks:**
- Use `go:generate` directives nos arquivos de interface
- Executar `go generate ./...` para gerar mocks
- Padrão: `//go:generate mockgen -destination=../../mocks/mock_usecase_repository_envelope.go -package=mocks`

### Configuração de Banco de Dados

**Tabela envelopes:**
- Usar GORM para auto-migration
- Seguir convenções de nomenclatura: snake_case para colunas
- Índices apropriados para performance (clicksign_key, status)
- Constraints de integridade referencial

**Relacionamentos:**
- Relacionamento many-to-many com documents através de tabela envelope_documents
- Usar GORM associations para gerenciar relacionamentos

### Padrões de Configuração

**Variáveis de Ambiente:**
- Usar configurações já definidas em config/environment.go
- CLICKSIGN_BASE_URL, CLICKSIGN_API_KEY, CLICKSIGN_TIMEOUT já configuradas
- Adicionar novas variáveis se necessário para envelope-specific configs

**Validações:**
- Usar tag `validate` nos campos da struct
- Implementar validações customizadas quando necessário
- Retornar erros descritivos para validações falhas
- Seguir padrão de validação da entidade Document

### Casos de Uso Práticos do Microserviço

**Casos de Uso para Documentação:**

#### Caso de Uso 1: Contrato de Prestação de Serviços

**Cenário:** Uma empresa precisa enviar um contrato de prestação de serviços para assinatura do cliente.

**Fluxo:**
1. Upload do documento PDF do contrato
2. Criação do envelope com informações do contrato
3. Adição dos signatários (empresa e cliente)
4. Ativação do envelope para assinatura
5. Monitoramento do status de assinatura

**Exemplo de Request:**
```bash
# 1. Criar documento no sistema
POST /api/v1/documents
Content-Type: application/json

{
  "name": "Contrato de Prestação de Serviços - Cliente ABC",
  "file_path": "/uploads/contrato_abc_2025.pdf",
  "file_size": 1048576,
  "mime_type": "application/pdf",
  "description": "Contrato de desenvolvimento de software"
}

# 2. Criar envelope no Clicksign
POST /api/v1/envelopes
Content-Type: application/json

{
  "name": "Contrato de Prestação de Serviços - Cliente ABC",
  "description": "Contrato de desenvolvimento de software para o cliente ABC",
  "documents_ids": [1],
  "signatory_emails": ["empresa@exemplo.com", "cliente@abc.com"],
  "message": "Favor assinar o contrato de prestação de serviços conforme acordado.",
  "deadline_at": "2025-08-15T23:59:59Z"
}
```

**Exemplo de Response:**
```json
{
  "id": 123,
  "name": "Contrato de Prestação de Serviços - Cliente ABC",
  "status": "draft",
  "clicksign_key": "12345678-1234-1234-1234-123456789012",
  "created_at": "2025-07-18T10:00:00Z",
  "updated_at": "2025-07-18T10:00:00Z"
}
```

#### Caso de Uso 2: Acordo de Confidencialidade (NDA)

**Cenário:** RH precisa coletar assinatura de NDA de novos funcionários.

**Fluxo:**
1. Upload do template de NDA
2. Criação do envelope com prazo de 48 horas
3. Envio para múltiplos funcionários
4. Configuração de lembretes diários

**Exemplo de Request:**
```bash
POST /api/v1/envelopes
Content-Type: application/json

{
  "name": "NDA - Novos Funcionários Julho 2025",
  "description": "Acordo de confidencialidade para novos colaboradores",
  "documents_ids": [2],
  "signatory_emails": [
    "joao.silva@empresa.com",
    "maria.santos@empresa.com",
    "carlos.oliveira@empresa.com"
  ],
  "message": "Bem-vindo(a) à empresa! Por favor, assine o acordo de confidencialidade.",
  "deadline_at": "2025-07-20T17:00:00Z",
  "remind_interval": 1
}
```

#### Caso de Uso 3: Termo de Consentimento Médico

**Cenário:** Clínica médica precisa coletar consentimento para procedimento.

**Fluxo:**
1. Upload do termo de consentimento
2. Criação de envelope urgente (24h)
3. Envio para paciente e responsável
4. Ativação imediata do envelope

**Exemplo de Request:**
```bash
POST /api/v1/envelopes
Content-Type: application/json

{
  "name": "Termo de Consentimento - Procedimento Cirúrgico",
  "description": "Consentimento para cirurgia do paciente João Silva",
  "documents_ids": [3],
  "signatory_emails": [
    "paciente@email.com",
    "responsavel@email.com"
  ],
  "message": "Termo de consentimento para procedimento cirúrgico agendado para amanhã.",
  "deadline_at": "2025-07-19T12:00:00Z",
  "remind_interval": 2,
  "auto_close": true
}
```

#### Caso de Uso 4: Contrato de Locação Residencial

**Cenário:** Imobiliária precisa formalizar contrato de locação.

**Fluxo:**
1. Upload do contrato de locação
2. Criação de envelope com múltiplos signatários
3. Prazo de 7 dias para assinatura
4. Lembretes a cada 2 dias

**Exemplo de Request:**
```bash
POST /api/v1/envelopes
Content-Type: application/json

{
  "name": "Contrato de Locação - Apartamento Centro",
  "description": "Contrato de locação residencial - Rua das Flores, 123",
  "documents_ids": [4],
  "signatory_emails": [
    "proprietario@email.com",
    "inquilino@email.com",
    "fiador@email.com",
    "imobiliaria@email.com"
  ],
  "message": "Contrato de locação residencial para assinatura de todas as partes.",
  "deadline_at": "2025-07-25T23:59:59Z",
  "remind_interval": 2
}
```

#### Caso de Uso 5: Acordo de Parceria Empresarial

**Cenário:** Duas empresas precisam formalizar uma parceria comercial.

**Fluxo:**
1. Upload do acordo de parceria
2. Criação de envelope com representantes legais
3. Prazo de 15 dias para análise e assinatura
4. Lembretes semanais

**Exemplo de Request:**
```bash
POST /api/v1/envelopes
Content-Type: application/json

{
  "name": "Acordo de Parceria Comercial - Empresa XYZ",
  "description": "Acordo de parceria para desenvolvimento conjunto de produtos",
  "documents_ids": [5],
  "signatory_emails": [
    "diretor@empresaA.com",
    "legal@empresaA.com",
    "ceo@empresaXYZ.com",
    "juridico@empresaXYZ.com"
  ],
  "message": "Acordo de parceria comercial entre as empresas para análise e assinatura.",
  "deadline_at": "2025-08-02T17:00:00Z",
  "remind_interval": 7
}
```

### Exemplos de Monitoramento e Consultas

#### Consultar Status de Envelope

**Request:**
```bash
GET /api/v1/envelopes/123
```

**Response:**
```json
{
  "id": 123,
  "name": "Contrato de Prestação de Serviços - Cliente ABC",
  "status": "running",
  "clicksign_key": "12345678-1234-1234-1234-123456789012",
  "documents_ids": [1],
  "signatory_emails": ["empresa@exemplo.com", "cliente@abc.com"],
  "message": "Favor assinar o contrato de prestação de serviços conforme acordado.",
  "deadline_at": "2025-08-15T23:59:59Z",
  "created_at": "2025-07-18T10:00:00Z",
  "updated_at": "2025-07-18T10:15:00Z"
}
```

#### Listar Envelopes Ativos

**Request:**
```bash
GET /api/v1/envelopes?status=running
```

**Response:**
```json
{
  "envelopes": [
    {
      "id": 123,
      "name": "Contrato de Prestação de Serviços - Cliente ABC",
      "status": "running",
      "created_at": "2025-07-18T10:00:00Z"
    },
    {
      "id": 124,
      "name": "NDA - Novos Funcionários Julho 2025",
      "status": "running",
      "created_at": "2025-07-18T11:00:00Z"
    }
  ],
  "total": 2
}
```

### Tratamento de Erros e Cenários Especiais

#### Erro de Validação

**Request com dados inválidos:**
```bash
POST /api/v1/envelopes
Content-Type: application/json

{
  "name": "",
  "documents_ids": [],
  "signatory_emails": ["email-invalido"]
}
```

**Response:**
```json
{
  "error": "Validation failed",
  "details": [
    {
      "field": "name",
      "message": "Name is required and must be at least 3 characters"
    },
    {
      "field": "documents_ids",
      "message": "At least one document is required"
    },
    {
      "field": "signatory_emails",
      "message": "Invalid email format: email-invalido"
    }
  ]
}
```

#### Erro de Integração com Clicksign

**Response quando API do Clicksign está indisponível:**
```json
{
  "error": "External service temporarily unavailable",
  "message": "Unable to connect to Clicksign API. Please try again later.",
  "retry_after": 300,
  "correlation_id": "abc123-def456-ghi789"
}
```

## Change Log

| Date       | Version | Description                      | Author |
| ---------- | ------- | -------------------------------- | ------ |
| 2025-07-18 | 1.0     | Story criada com base no épico 2 | SM     |
| 2025-07-18 | 1.1     | Adicionadas tasks para documentação de exemplos de uso da API do Clicksign | SM     |
| 2025-07-18 | 1.2     | Adicionados 5 casos de uso práticos do microserviço com exemplos de payloads e respostas | SM     |